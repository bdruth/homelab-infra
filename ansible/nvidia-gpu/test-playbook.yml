---
# Test playbook for NVIDIA GPU configuration

- name: Import NVIDIA GPU configuration playbook
  import_playbook: main.yml

- name: Validate NVIDIA GPU configuration
  hosts: all
  become: true
  vars_files:
    - vars/main.yml
  tasks:
    - name: Check NVIDIA driver is installed
      ansible.builtin.command: nvidia-smi
      register: nvidia_smi_result
      changed_when: false
      ignore_errors: true
      when: nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool

    - name: Display NVIDIA driver status
      ansible.builtin.debug:
        msg: "NVIDIA driver status: {{ 'OK' if nvidia_smi_result.rc is defined and nvidia_smi_result.rc == 0 else 'Not properly installed or not enabled' }}"
      when: nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool

    - name: Check CUDA toolkit is installed
      ansible.builtin.command: nvcc --version
      register: nvcc_result
      changed_when: false
      ignore_errors: true
      when: nvidia_install_cuda_toolkit is defined and nvidia_install_cuda_toolkit | bool

    - name: Display CUDA toolkit status
      ansible.builtin.debug:
        msg: "CUDA toolkit status: {{ 'OK' if nvcc_result.rc is defined and nvcc_result.rc == 0 else 'Not properly installed or not enabled' }}"
      when: nvidia_install_cuda_toolkit is defined and nvidia_install_cuda_toolkit | bool

    - name: Check if docker-compose is installed
      ansible.builtin.command: docker-compose --version
      register: docker_compose_result
      changed_when: false
      ignore_errors: true
      when: install_docker_compose is defined and install_docker_compose | bool

    - name: Display docker-compose status
      ansible.builtin.debug:
        msg: "docker-compose status: {{ 'OK' if docker_compose_result.rc is defined and docker_compose_result.rc == 0 else 'Not properly installed or not enabled' }}"
      when: install_docker_compose is defined and install_docker_compose | bool

    - name: Check if btop is installed
      ansible.builtin.command: btop --version
      register: btop_result
      changed_when: false
      ignore_errors: true
      when: install_btop is defined and install_btop | bool

    - name: Display btop status
      ansible.builtin.debug:
        msg: "btop status: {{ 'OK' if btop_result.rc is defined and btop_result.rc == 0 else 'Not properly installed or not enabled' }}"
      when: install_btop is defined and install_btop | bool

    - name: Check if Ollama is installed
      ansible.builtin.command: ollama --version
      register: ollama_result
      changed_when: false
      ignore_errors: true
      when: install_ollama is defined and install_ollama | bool

    - name: Display Ollama status
      ansible.builtin.debug:
        msg: "Ollama status: {{ 'OK' if ollama_result.rc is defined and ollama_result.rc == 0 else 'Not properly installed or not enabled' }}"
      when: install_ollama is defined and install_ollama | bool

    - name: Check if uv is installed with bash
      ansible.builtin.command: bash -i -c "uv --version"
      register: uv_result
      changed_when: false
      ignore_errors: true
      when: install_uv is defined and install_uv | bool

    - name: Display uv status
      ansible.builtin.debug:
        msg: "uv status: {{ 'OK' if uv_result.rc is defined and uv_result.rc == 0 else 'Not properly installed or not enabled' }}"
      when: install_uv is defined and install_uv | bool

    - name: Wait for n8n container to start
      ansible.builtin.shell: docker ps | grep n8n
      register: n8n_result
      changed_when: false
      ignore_errors: true
      retries: 15
      delay: 4
      until: n8n_result.rc == 0
      when: install_n8n is defined and install_n8n | bool

    - name: Display n8n status
      ansible.builtin.debug:
        msg: "n8n status: {{ 'OK' if n8n_result.rc is defined and n8n_result.rc == 0 else 'Not properly installed or not running' }}"
      when: install_n8n is defined and install_n8n | bool

    - name: Wait for Whisper ASR container to start
      ansible.builtin.shell: docker ps | grep whisper
      register: whisper_asr_result
      changed_when: false
      ignore_errors: true
      retries: 15
      delay: 4
      until: whisper_asr_result.rc == 0
      when: install_whisper_asr is defined and install_whisper_asr | bool

    - name: Display Whisper ASR status
      ansible.builtin.debug:
        msg: "Whisper ASR status: {{ 'OK' if whisper_asr_result.rc is defined and whisper_asr_result.rc == 0 else 'Not properly installed or not running' }}"
      when: install_whisper_asr is defined and install_whisper_asr | bool

    - name: Wait for Whisper ASR HTTP service to become available
      ansible.builtin.uri:
        url: "http://localhost:{{ whisper_asr_port }}/docs"
        method: GET
        status_code: 200
        timeout: 120
      register: whisper_http_check
      retries: 12
      delay: 5
      until: whisper_http_check.status == 200
      ignore_errors: true
      when:
        - install_whisper_asr is defined and install_whisper_asr | bool
        - whisper_asr_result.rc is defined and whisper_asr_result.rc == 0

    - name: Check if CUDA is available inside Whisper ASR container
      ansible.builtin.shell: >
        docker exec whisper-asr /bin/bash -c "source .venv/bin/activate && python3 -c 'import torch; print(torch.cuda.is_available())'"
      register: whisper_cuda_result
      changed_when: false
      ignore_errors: true
      when:
        - install_whisper_asr is defined and install_whisper_asr | bool
        - nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool
        - whisper_asr_result.rc is defined and whisper_asr_result.rc == 0
        - whisper_http_check.status is defined and whisper_http_check.status == 200

    - name: Display Whisper ASR CUDA access status
      ansible.builtin.debug:
        msg: "Whisper ASR CUDA access: {{ 'OK - GPU access confirmed' if whisper_cuda_result.stdout_lines[0] == 'True' else 'Not connected to GPU' }}"
      when:
        - install_whisper_asr is defined and install_whisper_asr | bool
        - nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool
        - whisper_asr_result.rc is defined and whisper_asr_result.rc == 0
        - whisper_http_check.status is defined and whisper_http_check.status == 200
        
    - name: Wait for Open WebUI container to start
      ansible.builtin.shell: docker ps | grep open-webui
      register: open_webui_result
      changed_when: false
      ignore_errors: true
      retries: 15
      delay: 4
      until: open_webui_result.rc == 0
      when: install_open_webui is defined and install_open_webui | bool

    - name: Display Open WebUI status
      ansible.builtin.debug:
        msg: "Open WebUI status: {{ 'OK' if open_webui_result.rc is defined and open_webui_result.rc == 0 else 'Not properly installed or not running' }}"
      when: install_open_webui is defined and install_open_webui | bool

    - name: Wait for Open WebUI HTTP service to become available
      ansible.builtin.uri:
        url: "http://localhost:{{ open_webui_port }}"
        method: GET
        status_code: 200
        timeout: 120
      register: open_webui_http_check
      retries: 12
      delay: 5
      until: open_webui_http_check.status == 200
      ignore_errors: true
      when:
        - install_open_webui is defined and install_open_webui | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0

    - name: Check if CUDA is available inside Open WebUI container
      ansible.builtin.shell: >
        docker exec open-webui /bin/bash -c "python3 -c 'import torch; print(torch.cuda.is_available())'"
      register: open_webui_cuda_result
      changed_when: false
      ignore_errors: true
      when:
        - install_open_webui is defined and install_open_webui | bool
        - nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0
        - open_webui_http_check.status is defined and open_webui_http_check.status == 200

    - name: Display Open WebUI CUDA access status
      ansible.builtin.debug:
        msg: "Open WebUI CUDA access: {{ 'OK - GPU access confirmed' if open_webui_cuda_result.stdout_lines[0] == 'True' else 'Not connected to GPU' }}"
      when:
        - install_open_webui is defined and install_open_webui | bool
        - nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0
        - open_webui_http_check.status is defined and open_webui_http_check.status == 200
        
    - name: Check Open WebUI Web RAG configuration
      ansible.builtin.shell: >
        docker inspect open-webui | grep -E "ENABLE_RAG_WEB_SEARCH|ENABLE_SEARCH_QUERY_GENERATION|RAG_WEB_SEARCH_ENGINE|RAG_WEB_LOADER_ENGINE"
      register: open_webui_rag_config_result
      changed_when: false
      ignore_errors: true
      when:
        - install_open_webui is defined and install_open_webui | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0
        - open_webui_enable_rag_web_search is defined and open_webui_enable_rag_web_search | bool
        
    - name: Display Open WebUI Web RAG configuration status
      ansible.builtin.debug:
        msg: "Open WebUI Web RAG configuration: {{ 'OK - Configured correctly' if open_webui_rag_config_result.rc is defined and open_webui_rag_config_result.rc == 0 else 'Not properly configured' }}"
      when:
        - install_open_webui is defined and install_open_webui | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0
        - open_webui_enable_rag_web_search is defined and open_webui_enable_rag_web_search | bool
        
    - name: Check Open WebUI Image Generation configuration
      ansible.builtin.shell: >
        docker inspect open-webui | grep -E "COMFYUI_BASE_URL|ENABLE_IMAGE_GENERATION"
      register: open_webui_image_gen_result
      changed_when: false
      ignore_errors: true
      when:
        - install_open_webui is defined and install_open_webui | bool
        - install_comfyui is defined and install_comfyui | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0
        - open_webui_enable_image_generation is defined and open_webui_enable_image_generation | bool
        
    - name: Display Open WebUI Image Generation status
      ansible.builtin.debug:
        msg: "Open WebUI Image Generation: {{ 'OK - Configured correctly' if open_webui_image_gen_result.rc is defined and open_webui_image_gen_result.rc == 0 else 'Not properly configured' }}"
      when:
        - install_open_webui is defined and install_open_webui | bool
        - install_comfyui is defined and install_comfyui | bool
        - open_webui_result.rc is defined and open_webui_result.rc == 0
        - open_webui_enable_image_generation is defined and open_webui_enable_image_generation | bool
        
    - name: Wait for Watchtower container to start
      ansible.builtin.shell: docker ps | grep watchtower
      register: watchtower_result
      changed_when: false
      ignore_errors: true
      retries: 15
      delay: 4
      until: watchtower_result.rc == 0
      when: install_watchtower is defined and install_watchtower | bool

    - name: Display Watchtower status
      ansible.builtin.debug:
        msg: "Watchtower status: {{ 'OK' if watchtower_result.rc is defined and watchtower_result.rc == 0 else 'Not properly installed or not running' }}"
      when: install_watchtower is defined and install_watchtower | bool

    - name: Check Watchtower configuration
      ansible.builtin.shell: >
        docker inspect watchtower | grep -A 10 -i env
      register: watchtower_config_result
      changed_when: false
      ignore_errors: true
      when:
        - install_watchtower is defined and install_watchtower | bool
        - watchtower_result.rc is defined and watchtower_result.rc == 0
        
    - name: Check for Pushover notification configuration
      ansible.builtin.shell: >
        docker inspect watchtower | grep -i pushover
      register: watchtower_pushover_result
      changed_when: false
      ignore_errors: true
      when:
        - install_watchtower is defined and install_watchtower | bool
        - watchtower_notifications_enabled is defined and watchtower_notifications_enabled | bool
        - watchtower_result.rc is defined and watchtower_result.rc == 0

    - name: Display Watchtower configuration status
      ansible.builtin.debug:
        msg: "Watchtower configuration: {{ 'OK' if watchtower_config_result.rc is defined and watchtower_config_result.rc == 0 else 'Could not retrieve configuration' }}"
      when:
        - install_watchtower is defined and install_watchtower | bool
        - watchtower_result.rc is defined and watchtower_result.rc == 0
        
    - name: Display Pushover notification status
      ansible.builtin.debug:
        msg: "Watchtower Pushover notifications: {{ 'Configured' if watchtower_pushover_result.rc is defined and watchtower_pushover_result.rc == 0 else 'Not configured' }}"
      when:
        - install_watchtower is defined and install_watchtower | bool
        - watchtower_notifications_enabled is defined and watchtower_notifications_enabled | bool
        - watchtower_result.rc is defined and watchtower_result.rc == 0
        
    - name: Check if ComfyUI installation exists
      ansible.builtin.stat:
        path: "{{ comfyui_install_dir }}/main.py"
      register: comfyui_install_check
      when: install_comfyui is defined and install_comfyui | bool

    - name: Display ComfyUI installation status
      ansible.builtin.debug:
        msg: "ComfyUI installation: {{ 'OK - Installed' if comfyui_install_check.stat.exists else 'Not properly installed' }}"
      when: install_comfyui is defined and install_comfyui | bool
      
    - name: Check if Python virtual environment exists
      ansible.builtin.stat:
        path: "{{ comfyui_venv_path }}/bin/python"
      register: comfyui_venv_check
      when: 
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Display Python venv status
      ansible.builtin.debug:
        msg: "ComfyUI Python venv: {{ 'OK - Environment setup' if comfyui_venv_check.stat.exists else 'Virtual environment missing' }}"
      when: 
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Check if CUDA is available for ComfyUI
      ansible.builtin.command:
        cmd: "{{ comfyui_venv_path }}/bin/python -c 'import torch; print(torch.cuda.is_available())'"
      register: comfyui_cuda_result
      changed_when: false
      ignore_errors: true
      become: yes
      become_user: "{{ comfyui_user }}"
      when:
        - install_comfyui is defined and install_comfyui | bool
        - nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        - comfyui_venv_check.stat.exists is defined and comfyui_venv_check.stat.exists

    - name: Display ComfyUI CUDA access status
      ansible.builtin.debug:
        msg: "ComfyUI CUDA access: {{ 'OK - GPU access confirmed' if comfyui_cuda_result.stdout_lines[0] == 'True' else 'Not connected to GPU' }}"
      when:
        - install_comfyui is defined and install_comfyui | bool
        - nvidia_install_gpu_drivers is defined and nvidia_install_gpu_drivers | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        - comfyui_venv_check.stat.exists is defined and comfyui_venv_check.stat.exists
        - comfyui_cuda_result is defined

    - name: Check if ComfyUI service is running
      ansible.builtin.systemd:
        name: comfyui
        state: started
      register: comfyui_service_status
      ignore_errors: true
      when: 
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        - comfyui_venv_check.stat.exists is defined and comfyui_venv_check.stat.exists

    - name: Display ComfyUI service status
      ansible.builtin.debug:
        msg: "ComfyUI service status: {{ 'OK - Service running' if comfyui_service_status.status.ActiveState == 'active' else 'Service not running' }}"
      when: 
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        - comfyui_venv_check.stat.exists is defined and comfyui_venv_check.stat.exists
        
    - name: Check if FLUX.1 model files are installed
      ansible.builtin.stat:
        path: "{{ comfyui_install_dir }}/models/checkpoints/{{ comfyui_flux1_model_filename }}"
      register: flux1_model_check
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_flux1 is defined and comfyui_install_flux1 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Check if FLUX.1 VAE model is installed
      ansible.builtin.stat:
        path: "{{ comfyui_install_dir }}/models/vae/ae.safetensors"
      register: flux1_vae_check
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_flux1 is defined and comfyui_install_flux1 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Check if FLUX.1 CLIP model is installed
      ansible.builtin.stat:
        path: "{{ comfyui_install_dir }}/models/clip/clip_l.safetensors"
      register: flux1_clip_check
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_flux1 is defined and comfyui_install_flux1 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Check if FLUX.1 T5XXL model is installed
      ansible.builtin.stat:
        path: "{{ comfyui_install_dir }}/models/clip/{{ comfyui_t5xxl_filename }}"
      register: flux1_t5xxl_check
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_flux1 is defined and comfyui_install_flux1 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Display FLUX.1 models status
      ansible.builtin.debug:
        msg: >
          FLUX.1 models status:
          - Main model ({{ comfyui_flux1_model_filename }}): {{ 'OK - Installed' if flux1_model_check.stat.exists else 'Not found' }}
          - VAE model: {{ 'OK - Installed' if flux1_vae_check.stat.exists else 'Not found' }}
          - CLIP model: {{ 'OK - Installed' if flux1_clip_check.stat.exists else 'Not found' }}
          - T5XXL model: {{ 'OK - Installed' if flux1_t5xxl_check.stat.exists else 'Not found' }}
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_flux1 is defined and comfyui_install_flux1 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        
    - name: Check if SD v1.5 model is installed
      ansible.builtin.stat:
        path: "{{ comfyui_install_dir }}/models/checkpoints/{{ comfyui_sd_v15_filename }}"
      register: sd_v15_check
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_sd_v15 is defined and comfyui_install_sd_v15 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        
    - name: Display SD v1.5 model status
      ansible.builtin.debug:
        msg: "Stable Diffusion v1.5 model status: {{ 'OK - Installed' if sd_v15_check.stat.exists else 'Not found' }}"
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_sd_v15 is defined and comfyui_install_sd_v15 | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists

    - name: Wait for ComfyUI HTTP service to become available
      ansible.builtin.uri:
        url: "http://{{ ansible_default_ipv4.address }}:{{ comfyui_port }}"
        method: GET
        status_code: 200
        timeout: 120
      register: comfyui_http_check
      retries: 12
      delay: 5
      until: comfyui_http_check.status == 200
      ignore_errors: true
      when:
        - install_comfyui is defined and install_comfyui | bool
        - comfyui_install_check.stat.exists is defined and comfyui_install_check.stat.exists
        - comfyui_venv_check.stat.exists is defined and comfyui_venv_check.stat.exists
        - comfyui_service_status.status.ActiveState is defined and comfyui_service_status.status.ActiveState == 'active'
        
    - name: Check docker-compose file
      ansible.builtin.stat:
        path: "{{ watchtower_install_dir }}/docker-compose.yml"
      register: watchtower_compose_file
      when:
        - install_watchtower is defined and install_watchtower | bool

    - name: Display Watchtower docker-compose file status
      ansible.builtin.debug:
        msg: "Watchtower docker-compose file: {{ 'OK' if watchtower_compose_file.stat.exists else 'Not found' }}"
      when:
        - install_watchtower is defined and install_watchtower | bool
