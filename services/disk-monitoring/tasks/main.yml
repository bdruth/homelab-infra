---
# Disk Monitoring Configuration Tasks

- name: Set role directory path
  ansible.builtin.set_fact:
    disk_monitoring_role_path: "{{ role_path | default(playbook_dir) }}"

- name: Check if host-specific variables file exists
  ansible.builtin.stat:
    path: "{{ disk_monitoring_role_path }}/vars/{{ inventory_hostname }}.yml"
  register: host_vars_check
  delegate_to: localhost

- name: Load host-specific variables
  ansible.builtin.include_vars:
    file: "{{ disk_monitoring_role_path }}/vars/{{ inventory_hostname }}.yml"
  when: host_vars_check.stat.exists

- name: Install InfluxData archive keyring package
  ansible.builtin.apt:
    name: influxdata-archive-keyring
    state: present
  register: keyring_pkg
  ignore_errors: true
  when: ansible_facts["os_family"] == "Debian"

- name: Fetch InfluxData GPG key (fallback if keyring package unavailable)
  ansible.builtin.shell: >-
    curl -fsSL https://repos.influxdata.com/influxdata-archive_compat-exp2029.key
    | gpg --dearmor
    | tee /usr/share/keyrings/influxdata-archive.gpg > /dev/null
  args:
    creates: /usr/share/keyrings/influxdata-archive.gpg
  when: ansible_facts["os_family"] == "Debian" and keyring_pkg is failed

- name: Remove old InfluxData repository files
  ansible.builtin.shell: rm -f /etc/apt/sources.list.d/repos_influxdata_com_*.list
  args:
    removes: /etc/apt/sources.list.d/repos_influxdata_com_debian.list
  when: ansible_facts["os_family"] == "Debian"

- name: Remove old InfluxData apt key
  ansible.builtin.apt_key:
    id: 9D539D90D3328DC7D6C8D3B9D8FF8E1F7DF8B07E
    state: absent
  ignore_errors: true
  when: ansible_facts["os_family"] == "Debian"

- name: Add InfluxData repository (signed-by keyring)
  ansible.builtin.copy:
    content: "deb [signed-by=/usr/share/keyrings/influxdata-archive.gpg] https://repos.influxdata.com/debian stable main\n"
    dest: /etc/apt/sources.list.d/influxdata.list
    mode: "0644"
  register: influxdata_repo
  when: ansible_facts["os_family"] == "Debian"

- name: Remove old-style InfluxData repository entry
  ansible.builtin.apt_repository:
    repo: >-
      deb https://repos.influxdata.com/{{ ansible_facts["distribution"] | lower }}
      {{ 'jammy' if ansible_facts["distribution_release"] in ['noble', 'mantic'] else ansible_facts["distribution_release"] }}
      stable
    state: absent
  ignore_errors: true
  when: ansible_facts["os_family"] == "Debian"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  when: ansible_facts["os_family"] == "Debian" and (influxdata_repo is changed)

- name: Install Telegraf
  ansible.builtin.package:
    name: telegraf
    state: present
  register: telegraf_installed

- name: Create Telegraf configuration directory
  ansible.builtin.file:
    path: /etc/telegraf/telegraf.d
    state: directory
    mode: "0755"

- name: Configure Telegraf disk monitoring
  ansible.builtin.template:
    src: telegraf-disk.conf.j2
    dest: /etc/telegraf/telegraf.d/disk.conf
    mode: "0644"
  register: telegraf_config_updated
  notify: Restart telegraf

- name: Start and enable Telegraf service
  ansible.builtin.systemd:
    name: telegraf
    state: started
    enabled: true
